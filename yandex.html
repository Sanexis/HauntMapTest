<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ó–æ–Ω—ã –∂–∏–≤–æ—Ç–Ω—ã—Ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api-maps.yandex.ru/2.1/?apikey=8241a41f-a917-4e32-b474-72da885f6ce6&lang=ru_RU"></script>
  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100%; }
    .panel {
      position:absolute; top:12px; left:12px; z-index:1000; width: 400px;
      background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,.2);
      min-width:280px; user-select:none;
    }
    .row { display:flex; gap:8px; }
    .type { flex:1; padding:8px 10px; border:2px solid transparent; border-radius:6px; text-align:center; cursor:pointer; font-weight:600; }
    .type.active { border-color:#000; }
    .type.bear { background:#8B4513; color:#fff; }
    .type.wolf { background:#808080; color:#fff; }
    .type.fox  { background:#FFA500; color:#000; }
    .btn { width:100%; margin-top:8px; padding:10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; background:#4CAF50; color:#fff; }
    .btn:disabled { background:#c9c9c9; cursor:not-allowed; }
    .btn-danger { background:#f44336; }
    .btn-secondary { background:#607D8B; }
    .hint { margin-top:8px; font-size:12px; color:#666; min-height:1.2em;}
    .totals { margin-top:10px; font-size:13px; line-height:1.4; }
    .totals div { display:flex; justify-content:space-between; }
    .totals .sum { font-weight:700; border-top:1px solid #eee; padding-top:6px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="row">
      <div class="type bear active" data-type="bear">üêª –ú–µ–¥–≤–µ–¥—å</div>
      <div class="type wolf" data-type="wolf">üê∫ –í–æ–ª–∫</div>
      <div class="type fox"  data-type="fox">ü¶ä –õ–∏—Å–∏—Ü–∞</div>
    </div>

    <button id="start"  class="btn">–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>
    <button id="finish" class="btn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button id="cancel" class="btn" disabled>–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>

    <button id="editMode" class="btn btn-secondary" style="margin-top:14px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="editDone" class="btn btn-secondary" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button id="deleteSel" class="btn btn-danger" disabled>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π</button>

    <button id="clear"  class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>

    <div id="status" class="hint"></div>

    <div class="totals" id="totals">
      <div><span>üêª –ú–µ–¥–≤–µ–¥—å</span><span id="sum-bear">0 –º¬≤</span></div>
      <div><span>üê∫ –í–æ–ª–∫</span><span id="sum-wolf">0 –º¬≤</span></div>
      <div><span>ü¶ä –õ–∏—Å–∏—Ü–∞</span><span id="sum-fox">0 –º¬≤</span></div>
      <div class="sum"><span>–ò—Ç–æ–≥–æ</span><span id="sum-all">0 –º¬≤</span></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
    let map, finals, temps;
    let drawing = false, editMode = false, selectedPoly = null;
    let points = [], vertexMarks = [], tempPolygon = null, currentType = 'bear';
    let nextId = 1; // –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç id –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤

    const LS_KEY = 'animal_zones_v1';

    const styles = {
      bear: { name:'–ú–µ–¥–≤–µ–∂—å—è –∑–æ–Ω–∞', emoji:'üêª', fill:'#8B4513', stroke:'#654321' },
      wolf: { name:'–í–æ–ª—á—å—è –∑–æ–Ω–∞',   emoji:'üê∫', fill:'#808080', stroke:'#696969' },
      fox:  { name:'–õ–∏—Å—å—è –∑–æ–Ω–∞',    emoji:'ü¶ä', fill:'#FFA500', stroke:'#FF8C00' }
    };

    ymaps.ready(function init() {
      map = new ymaps.Map('map', { center:[55.76,37.64], zoom:10, controls:['zoomControl'] });
      finals = new ymaps.GeoObjectCollection();
      temps  = new ymaps.GeoObjectCollection();
      map.geoObjects.add(finals);
      map.geoObjects.add(temps);

      // –í—ã–±–æ—Ä —Ç–∏–ø–∞
      document.querySelectorAll('.type').forEach(el => {
        el.addEventListener('click', () => {
          if (drawing || editMode) return;
          document.querySelectorAll('.type').forEach(x => x.classList.remove('active'));
          el.classList.add('active');
          currentType = el.dataset.type;
        });
      });

      // –ö–Ω–æ–ø–∫–∏
      byId('start').addEventListener('click', startDrawing);
      byId('finish').addEventListener('click', finishDrawing);
      byId('cancel').addEventListener('click', cancelDrawing);

      byId('editMode').addEventListener('click', enableEditMode);
      byId('editDone').addEventListener('click', finishEditing);
      byId('deleteSel').addEventListener('click', deleteSelected);

      byId('clear').addEventListener('click', clearAll);

      setStatus('–ì–æ—Ç–æ–≤–æ.');
      restoreFromLocalStorage(); // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–æ–Ω—ã
    });

    // -------- –†–ò–°–û–í–ê–ù–ò–ï --------
    function startDrawing() {
      if (drawing || editMode) return;
      drawing = true;
      points = [];
      vertexMarks = [];
      tempPolygon = null;
      temps.removeAll();
      toggleDrawUI(true);
      setStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ: –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ (‚â•3 —Ç–æ—á–∫–∏).');

      map.behaviors.disable(['drag','scrollZoom']);
      map.events.add('click', onMapClick);
    }

    function onMapClick(e) {
      if (!drawing) return;
      addVertex(e.get('coords'));
    }

    function addVertex(coords) {
      points.push(coords);
      const idx = points.length - 1;

      const mark = new ymaps.Placemark(coords, {}, {
        preset:'islands#blueCircleIcon',
        draggable:true,
        interactivityModel:'default#transparent'
      });

      mark.events.add('drag', () => {
        points[idx] = mark.geometry.getCoordinates();
        redrawTempPolygon();
      });

      temps.add(mark);
      vertexMarks.push(mark);
      redrawTempPolygon();
    }

    function redrawTempPolygon() {
      if (tempPolygon) {
        temps.remove(tempPolygon);
        tempPolygon = null;
      }
      if (points.length >= 2) {
        const s = styles[currentType];
        tempPolygon = new ymaps.Polygon([points], {}, {
          fillColor: s.fill,
          strokeColor: s.stroke,
          strokeWidth: 2,
          fillOpacity: 0.3,
          interactivityModel:'default#transparent'
        });
        temps.add(tempPolygon);
      }
    }

    function finishDrawing() {
      if (!drawing) return;
      if (points.length < 3) { setStatus('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.'); return; }
      const poly = buildFinal(points.slice(), currentType, undefined); // id —Å–≥–µ–Ω–µ—Ä–∏—Ç—Å—è
      finals.add(poly);
      stopDrawing();
      setStatus('–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω.');
      persistToLocalStorage(); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    }

    function cancelDrawing() {
      if (!drawing) return;
      stopDrawing();
      setStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
    }

    function stopDrawing() {
      drawing = false;
      points = [];
      vertexMarks = [];
      temps.removeAll();
      tempPolygon = null;

      toggleDrawUI(false);
      map.behaviors.enable(['drag','scrollZoom']);
      map.events.remove('click', onMapClick);
    }

    // -------- –°–û–ó–î–ê–ù–ò–ï –ì–û–¢–û–í–û–ì–û –ü–û–õ–ò–ì–û–ù–ê + –≠–ú–û–î–ó–ò --------
    function buildFinal(coords, type, forcedId) {
      const s = styles[type];
      const id = forcedId ?? nextId++;

      const poly = new ymaps.Polygon([coords], {
        hintContent: `${s.emoji} ${s.name}`,
        balloonContent: `<strong>${s.name}</strong><br>${s.emoji}<br>–í–µ—Ä—à–∏–Ω: ${coords.length}`,
        zoneType: type,
        zoneId: id
      }, {
        fillColor: s.fill,
        strokeColor: s.stroke,
        strokeWidth: 3,
        fillOpacity: 0.5,
        interactivityModel:'default#transparent'
      });

      // —ç–º–æ–¥–∑–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ
      const center = centroid(coords);
      const emoji = new ymaps.Placemark(center, { iconContent: s.emoji }, {
        iconLayout:'default#imageWithContent',
        iconImageHref:'',
        iconImageSize:[40,40],
        iconImageOffset:[-20,-20],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
          '<div style="font-size:24px;width:40px;height:40px;line-height:40px;text-align:center;">{{ properties.iconContent }}</div>'
        ),
        interactivityModel:'default#transparent'
      });

      // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞ –∏ –ø–ª–æ—â–∞–¥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
      poly.events.add('geometrychange', () => {
        const all = poly.geometry.getCoordinates();
        const ring = all[0];
        emoji.geometry.setCoordinates(centroid(ring));
        // –ø–µ—Ä–µ—Å—á—ë—Ç –ø–ª–æ—â–∞–¥–∏ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        const area = areaMeters2(ring);
        poly.properties.set('area_m2', area);
        persistToLocalStorage();
        updateTotalsUI(); // –±—ã—Å—Ç—Ä–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
      });

      // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      poly.events.add('click', (e) => {
        if (!editMode) return;
        e.stopPropagation();
        selectPolygon(poly);
      });

      // –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å
      const area = areaMeters2(coords);
      poly.properties.set('area_m2', area);

      finals.add(emoji);
      poly.properties.set('emoji', emoji);

      return poly;
    }

    // -------- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï --------
    function enableEditMode() {
      if (drawing || editMode) return;
      editMode = true;
      setStatus('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫—É, –¥–≤–∏–≥–∞–π—Ç–µ –≤–µ—Ä—à–∏–Ω—ã.');
      setPolysInteractivity('default#geoObject'); // —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –ø–æ–ª–∏–≥–æ–Ω–∞–º
      byId('editMode').disabled = true;
      byId('editDone').disabled = false;
      updateDeleteBtn();
    }

    function finishEditing() {
      if (!editMode) return;
      if (selectedPoly && selectedPoly.editor) {
        selectedPoly.editor.stopEditing();
        setStroke(selectedPoly, false);
        selectedPoly = null;
      }
      editMode = false;
      setPolysInteractivity('default#transparent'); // —Å–Ω–æ–≤–∞ –¥–µ–ª–∞–µ–º –∏—Ö ¬´–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏¬ª
      byId('editMode').disabled = false;
      byId('editDone').disabled = true;
      updateDeleteBtn();
      setStatus('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.');
      persistToLocalStorage(); // –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      updateTotalsUI();
    }

    function selectPolygon(poly) {
      if (selectedPoly === poly) return;
      if (selectedPoly) {
        selectedPoly.editor && selectedPoly.editor.stopEditing();
        setStroke(selectedPoly, false);
      }
      selectedPoly = poly;
      setStroke(selectedPoly, true);
      selectedPoly.editor && selectedPoly.editor.startEditing();
      updateDeleteBtn();
    }

    function deleteSelected() {
      if (!selectedPoly) return;
      const emoji = selectedPoly.properties.get('emoji');
      if (emoji) finals.remove(emoji);
      finals.remove(selectedPoly);
      selectedPoly = null;
      updateDeleteBtn();
      setStatus('–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫ —É–¥–∞–ª—ë–Ω.');
      persistToLocalStorage(); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      updateTotalsUI();
    }

    function setStroke(poly, on) {
      poly.options.set({ strokeWidth: on ? 4 : 3, strokeStyle: on ? 'dash' : 'solid' });
    }

    function setPolysInteractivity(model) {
      finals.each(obj => {
        if (obj?.geometry?.getType?.() === 'Polygon') {
          obj.options.set('interactivityModel', model);
        }
        if (obj?.geometry?.getType?.() === 'Point') {
          obj.options.set('interactivityModel', 'default#transparent');
        }
      });
    }

    // -------- LOCALSTORAGE --------
    function persistToLocalStorage() {
      const zones = [];
      let maxId = nextId - 1;

      finals.each(obj => {
        if (obj?.geometry?.getType?.() !== 'Polygon') return;
        const id = obj.properties.get('zoneId');
        const type = obj.properties.get('zoneType');
        const coords = obj.geometry.getCoordinates()[0]; // –≤–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ
        const area = obj.properties.get('area_m2') ?? areaMeters2(coords);

        zones.push({ id, type, coords, area });
        if (typeof id === 'number' && id > maxId) maxId = id;
      });

      nextId = maxId + 1;

      const sums = zones.reduce((acc, z) => {
        acc[z.type] = (acc[z.type] || 0) + z.area;
        acc.all += z.area;
        return acc;
      }, { bear:0, wolf:0, fox:0, all:0 });

      const payload = { zones, sums, updatedAt: new Date().toISOString() };
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      } catch(e) {
        // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
      }
    }

    function restoreFromLocalStorage() {
      let data = null;
      try {
        data = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
      } catch(e) { data = null; }

      if (!data?.zones?.length) {
        updateTotalsUI(); // –Ω—É–ª–∏
        return;
      }

      // –í–æ—Å—Å–æ–∑–¥–∞—ë–º –ø–æ–ª–∏–≥–æ–Ω—ã
      for (const z of data.zones) {
        const poly = buildFinal(z.coords, z.type, z.id);
        // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–æ—â–∞–¥—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ ¬´—Å–∫–∞–∫–∞–ª–∞¬ª –æ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–π)
        poly.properties.set('area_m2', z.area);
        finals.add(poly);
        if (z.id >= nextId) nextId = z.id + 1;
      }

      updateTotalsUI(data.sums);
    }

    // -------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï --------
    // –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É (–¥–ª—è —ç–º–æ–¥–∑–∏)
    function centroid(coords) {
      let lat = 0, lon = 0;
      for (let i = 0; i < coords.length; i++) { lat += coords[i][0]; lon += coords[i][1]; }
      return [lat/coords.length, lon/coords.length];
    }

    // –ü–ª–æ—â–∞–¥—å –ø–æ–ª–∏–≥–æ–Ω–∞ –≤ –º¬≤: –ø—Ä–æ–µ—Ü–∏—Ä—É–µ–º –≤ Web Mercator –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º ¬´—à–Ω—É—Ä–æ–≤–∫—É¬ª
    // coords: [[lat, lon], ...]
    function areaMeters2(coords) {
      if (!coords || coords.length < 3) return 0;
      const pts = coords.map(ll => mercatorMeters(ll[0], ll[1]));
      let sum = 0;
      for (let i = 0, j = pts.length - 1; i < pts.length; j = i++) {
        sum += (pts[j].x * pts[i].y - pts[i].x * pts[j].y);
      }
      return Math.abs(sum / 2);
    }

    // Spherical Mercator (EPSG:3857) ‚Äî –≥—Ä—É–±–æ, –Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∑–æ–Ω –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
    function mercatorMeters(lat, lon) {
      const R = 6378137.0;
      const x = R * (lon * Math.PI / 180);
      const y = R * Math.log(Math.tan(Math.PI/4 + (lat * Math.PI / 180)/2));
      return { x, y };
    }

    // UI helpers
    function toggleDrawUI(inDrawing) {
      byId('start').disabled  = inDrawing;
      byId('finish').disabled = !inDrawing;
      byId('cancel').disabled = !inDrawing;
      byId('editMode').disabled = inDrawing || editMode;
      byId('editDone').disabled = true;
      updateDeleteBtn();
    }
    function clearAll() {
      finals.removeAll();
      if (drawing) stopDrawing();
      selectedPoly = null;
      updateDeleteBtn();
      setStatus('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞.');
      persistToLocalStorage();
      updateTotalsUI();
    }
    function updateDeleteBtn() {
      byId('deleteSel').disabled = !(editMode && selectedPoly);
    }
    function byId(id){ return document.getElementById(id); }
    function setStatus(t){ byId('status').textContent = t; }

    function fmtArea(m2) {
      if (m2 >= 1_000_000) return (m2/1_000_000).toFixed(2) + ' –∫–º¬≤';
      if (m2 >= 10_000)    return Math.round(m2).toLocaleString('ru-RU') + ' –º¬≤';
      return m2.toFixed(2) + ' –º¬≤';
    }

    function updateTotalsUI(sumsOpt) {
      let sums = sumsOpt;
      if (!sums) {
        // –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ ‚Äî —Å–æ–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        sums = { bear:0, wolf:0, fox:0, all:0 };
        finals.each(obj => {
          if (obj?.geometry?.getType?.() !== 'Polygon') return;
          const type = obj.properties.get('zoneType');
          const area = obj.properties.get('area_m2') || 0;
          sums[type] = (sums[type] || 0) + area;
          sums.all += area;
        });
      }
      byId('sum-bear').textContent = fmtArea(sums.bear || 0);
      byId('sum-wolf').textContent = fmtArea(sums.wolf || 0);
      byId('sum-fox').textContent  = fmtArea(sums.fox  || 0);
      byId('sum-all').textContent  = fmtArea(sums.all  || 0);
    }
  </script>
</body>
</html>
