<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ó–æ–Ω—ã –∂–∏–≤–æ—Ç–Ω—ã—Ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api-maps.yandex.ru/2.1/?apikey=8241a41f-a917-4e32-b474-72da885f6ce6&lang=ru_RU"></script>
  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100%; }
    .panel {
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,.2);
      min-width:260px; user-select:none;
    }
    .row { display:flex; gap:8px; }
    .type { flex:1; padding:8px 10px; border:2px solid transparent; border-radius:6px; text-align:center; cursor:pointer; font-weight:600; }
    .type.active { border-color:#000; }
    .type.bear { background:#8B4513; color:#fff; }
    .type.wolf { background:#808080; color:#fff; }
    .type.fox  { background:#FFA500; color:#000; }
    .btn { width:100%; margin-top:8px; padding:10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; background:#4CAF50; color:#fff; }
    .btn:disabled { background:#c9c9c9; cursor:not-allowed; }
    .btn-danger { background:#f44336; }
    .btn-secondary { background:#607D8B; }
    .hint { margin-top:8px; font-size:12px; color:#666; min-height:1.2em;}
  </style>
</head>
<body>
  <div class="panel">
    <div class="row">
      <div class="type bear active" data-type="bear">üêª –ú–µ–¥–≤–µ–∂—å—è</div>
      <div class="type wolf" data-type="wolf">üê∫ –í–æ–ª—á—å—è</div>
      <div class="type fox"  data-type="fox">ü¶ä –õ–∏—Å—å—è</div>
    </div>

    <button id="start"  class="btn">–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>
    <button id="finish" class="btn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button id="cancel" class="btn" disabled>–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>

    <button id="editMode" class="btn btn-secondary" style="margin-top:14px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="editDone" class="btn btn-secondary" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button id="deleteSel" class="btn btn-danger" disabled>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π</button>

    <button id="clear"  class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>

    <div id="status" class="hint"></div>
  </div>

  <div id="map"></div>

  <script>
    let map, finals, temps;
    let drawing = false, editMode = false, selectedPoly = null;

    let points = [], vertexMarks = [], tempPolygon = null, currentType = 'bear';

    const styles = {
      bear: { name:'–ú–µ–¥–≤–µ–∂—å—è –∑–æ–Ω–∞', emoji:'üêª', fill:'#8B4513', stroke:'#654321' },
      wolf: { name:'–í–æ–ª—á—å—è –∑–æ–Ω–∞',   emoji:'üê∫', fill:'#808080', stroke:'#696969' },
      fox:  { name:'–õ–∏—Å—å—è –∑–æ–Ω–∞',    emoji:'ü¶ä', fill:'#FFA500', stroke:'#FF8C00' }
    };

    ymaps.ready(function init() {
      map = new ymaps.Map('map', { center:[55.76,37.64], zoom:10, controls:['zoomControl'] });
      finals = new ymaps.GeoObjectCollection();
      temps  = new ymaps.GeoObjectCollection();
      map.geoObjects.add(finals);
      map.geoObjects.add(temps);

      document.querySelectorAll('.type').forEach(el => {
        el.addEventListener('click', () => {
          if (drawing || editMode) return;
          document.querySelectorAll('.type').forEach(x => x.classList.remove('active'));
          el.classList.add('active');
          currentType = el.dataset.type;
        });
      });

      byId('start').addEventListener('click', startDrawing);
      byId('finish').addEventListener('click', finishDrawing);
      byId('cancel').addEventListener('click', cancelDrawing);

      byId('editMode').addEventListener('click', enableEditMode);
      byId('editDone').addEventListener('click', finishEditing);
      byId('deleteSel').addEventListener('click', deleteSelected);

      byId('clear').addEventListener('click', clearAll);

      setStatus('–ì–æ—Ç–æ–≤–æ.');
    });

    // ---- —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ----
    function startDrawing() {
      if (drawing || editMode) return;
      drawing = true;
      points = [];
      vertexMarks = [];
      tempPolygon = null;
      temps.removeAll();
      toggleDrawUI(true);
      setStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ: –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ (‚â•3 —Ç–æ—á–∫–∏).');

      // —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ: –∫–ª–∏–∫–∏ –ø–æ –ø–æ–ª–∏–≥–æ–Ω–∞–º –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è, —Ç.–∫. –æ–Ω–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ (—Å–º. buildFinal)
      map.behaviors.disable(['drag','scrollZoom']);
      map.events.add('click', onMapClick);
    }

    function onMapClick(e) {
      if (!drawing) return;
      addVertex(e.get('coords'));
    }

    function addVertex(coords) {
      points.push(coords);
      const idx = points.length - 1;

      const mark = new ymaps.Placemark(coords, {}, {
        preset:'islands#blueCircleIcon',
        draggable:true,
        interactivityModel: 'default#transparent' // —Ç–æ–∂–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏
      });

      mark.events.add('drag', () => {
        points[idx] = mark.geometry.getCoordinates();
        redrawTempPolygon();
      });

      temps.add(mark);
      vertexMarks.push(mark);
      redrawTempPolygon();
    }

    function redrawTempPolygon() {
      if (tempPolygon) {
        temps.remove(tempPolygon);
        tempPolygon = null;
      }
      if (points.length >= 2) {
        const s = styles[currentType];
        tempPolygon = new ymaps.Polygon([points], {}, {
          fillColor: s.fill,
          strokeColor: s.stroke,
          strokeWidth: 2,
          fillOpacity: 0.3,
          interactivityModel: 'default#transparent'
        });
        temps.add(tempPolygon);
      }
    }

    function finishDrawing() {
      if (!drawing) return;
      if (points.length < 3) { setStatus('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.'); return; }
      const poly = buildFinal(points.slice(), currentType);
      finals.add(poly);
      stopDrawing();
      setStatus('–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω.');
    }

    function cancelDrawing() {
      if (!drawing) return;
      stopDrawing();
      setStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
    }

    function stopDrawing() {
      drawing = false;
      points = [];
      vertexMarks = [];
      temps.removeAll();
      tempPolygon = null;

      toggleDrawUI(false);
      map.behaviors.enable(['drag','scrollZoom']);
      map.events.remove('click', onMapClick);
    }

    function buildFinal(coords, type) {
      const s = styles[type];

      const poly = new ymaps.Polygon([coords], {
        hintContent: `${s.emoji} ${s.name}`,
        balloonContent: `<strong>${s.name}</strong><br>${s.emoji}<br>–í–µ—Ä—à–∏–Ω: ${coords.length}`
      }, {
        fillColor: s.fill,
        strokeColor: s.stroke,
        strokeWidth: 3,
        fillOpacity: 0.5,
        // –∫–ª—é—á: –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π —Ä–∞–±–æ—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –∑–æ–Ω—ã ¬´–ø—Ä–æ–∑—Ä–∞—á–Ω—ã¬ª –¥–ª—è –∫–ª–∏–∫–æ–≤
        interactivityModel: 'default#transparent'
      });

      const center = centroid(coords);
      const emoji = new ymaps.Placemark(center, { iconContent: s.emoji }, {
        iconLayout:'default#imageWithContent',
        iconImageHref:'',
        iconImageSize:[40,40],
        iconImageOffset:[-20,-20],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
          '<div style="font-size:24px;width:40px;height:40px;line-height:40px;text-align:center;">{{ properties.iconContent }}</div>'
        ),
        interactivityModel: 'default#transparent'
      });

      // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
      poly.events.add('geometrychange', () => {
        const all = poly.geometry.getCoordinates();
        const c = centroid(all[0]);
        emoji.geometry.setCoordinates(c);
      });

      finals.add(emoji);
      poly.properties.set('emoji', emoji);

      // –∫–ª–∏–∫–∏ –ø–æ –ø–æ–ª–∏–≥–æ–Ω—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      poly.events.add('click', (e) => {
        if (!editMode) return;
        e.stopPropagation();
        selectPolygon(poly);
      });

      return poly;
    }

    // ---- —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----
    function enableEditMode() {
      if (drawing || editMode) return;
      editMode = true;
      setStatus('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫—É, –¥–≤–∏–≥–∞–π—Ç–µ –≤–µ—Ä—à–∏–Ω—ã.');

      // –¥–µ–ª–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω—ã ¬´–Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏¬ª –¥–ª—è –∫–ª–∏–∫–æ–≤, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å
      setPolysInteractivity('default#geoObject');

      byId('editMode').disabled = true;
      byId('editDone').disabled = false;
      updateDeleteBtn();
    }

    function finishEditing() {
      if (!editMode) return;
      if (selectedPoly && selectedPoly.editor) {
        selectedPoly.editor.stopEditing();
        setStroke(selectedPoly, false);
        selectedPoly = null;
      }
      editMode = false;
      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
      setPolysInteractivity('default#transparent');

      byId('editMode').disabled = false;
      byId('editDone').disabled = true;
      updateDeleteBtn();
      setStatus('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.');
    }

    function selectPolygon(poly) {
      if (selectedPoly === poly) return;

      if (selectedPoly) {
        selectedPoly.editor && selectedPoly.editor.stopEditing();
        setStroke(selectedPoly, false);
      }
      selectedPoly = poly;
      setStroke(selectedPoly, true);
      selectedPoly.editor && selectedPoly.editor.startEditing();
      updateDeleteBtn();
    }

    function deleteSelected() {
      if (!selectedPoly) return;
      const emoji = selectedPoly.properties.get('emoji');
      if (emoji) finals.remove(emoji);
      finals.remove(selectedPoly);
      selectedPoly = null;
      updateDeleteBtn();
      setStatus('–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫ —É–¥–∞–ª—ë–Ω.');
    }

    function setStroke(poly, on) {
      poly.options.set({
        strokeWidth: on ? 4 : 3,
        strokeStyle: on ? 'dash' : 'solid'
      });
    }

    function setPolysInteractivity(model) {
      finals.each(obj => {
        if (obj && obj.geometry && obj.geometry.getType && obj.geometry.getType() === 'Polygon') {
          obj.options.set('interactivityModel', model);
        }
        // —ç–º–æ–¥–∑–∏ —Ç–æ–∂–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∫–ª–∏–∫–∏
        if (obj && obj.geometry && obj.geometry.getType && obj.geometry.getType() === 'Point') {
          obj.options.set('interactivityModel', model === 'default#geoObject' ? 'default#transparent' : 'default#transparent');
        }
      });
    }

    // ---- —É—Ç–∏–ª–∏—Ç—ã ----
    function centroid(coords) {
      let lat = 0, lon = 0;
      for (let i = 0; i < coords.length; i++) { lat += coords[i][0]; lon += coords[i][1]; }
      return [lat/coords.length, lon/coords.length];
    }
    function toggleDrawUI(inDrawing) {
      byId('start').disabled  = inDrawing;
      byId('finish').disabled = !inDrawing;
      byId('cancel').disabled = !inDrawing;
      byId('editMode').disabled = inDrawing || editMode;
      byId('editDone').disabled = true;
      updateDeleteBtn();
    }
    function clearAll() {
      finals.removeAll();
      if (drawing) stopDrawing();
      selectedPoly = null;
      updateDeleteBtn();
      setStatus('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞.');
    }
    function updateDeleteBtn() {
      byId('deleteSel').disabled = !(editMode && selectedPoly);
    }
    function byId(id){ return document.getElementById(id); }
    function setStatus(t){ byId('status').textContent = t; }
  </script>
</body>
</html>
